%HEADER%

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Telemetry</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f8f8;
      color: #333;
    }

    main {
      padding: 1rem;
    }

    canvas {
      width: 100%;
      max-width: 100%;
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <main>
    <canvas id="telemetryChart" height="300"></canvas>
  </main>

<script>
const currentTempData = [{ x: 0, y: 0 }];
const targetTempData = [{ x: 0, y: 0 }];
const powerData = [{ x: 0, y: 0 }];

const ctx = document.getElementById("telemetryChart").getContext("2d");

const chart = new Chart(ctx, {
  type: "line",
  data: {
    datasets: [
      {
        label: "Measured Temp (°C)",
        data: currentTempData,
        borderColor: "red",
        backgroundColor: "rgba(255, 0, 0, 0.1)",
        yAxisID: "y",
        pointRadius: 0,
        tension: 0.3,
      },
      {
        label: "Target Temp (°C)",
        data: targetTempData,
        borderColor: "orange",
        borderDash: [5, 5],
        backgroundColor: "rgba(255, 165, 0, 0.1)",
        yAxisID: "y",
        pointRadius: 0,
        tension: 0.3,
      },
      {
        label: "Heater Power Pct",
        data: powerData,
        borderColor: "blue",
        backgroundColor: "rgba(0, 0, 255, 0.1)",
        yAxisID: "y1",
        pointRadius: 0,
        tension: 0.3,
      }
    ]
  },
  options: {
    animation: false,
    parsing: false,
    scales: {
      x: {
        type: "linear",
        title: { display: true, text: "Time (s)" },
        //min: 0,
        //max: 30 // adjust as desired
      },
      y: {
        type: "linear",
        position: "left",
        title: { display: true, text: "Temperature (°C)" },
        min: 0,
        max: 130
      },
      y1: {
        type: "linear",
        position: "right",
        title: { display: true, text: "Heater Power (%)" },
        min: 0,
        max: 100,
        grid: { drawOnChartArea: false }
      }
    }
  }
});

const eventSource = new EventSource("/events");

eventSource.onmessage = (event) => {
  if (!event.data.startsWith("{")) return;
};

let startTime = null;
let isBrewing = false;

eventSource.addEventListener("brew_state", (event) => {
  const state = event.data;

  if (state === "start") {
    startTime = Date.now();
    isBrewing = true;
    currentTempData.length = 0;
    targetTempData.length = 0;
    powerData.length = 0;
    chart.update();
  } else if (state === "stop") {
    isBrewing = false;
  }
});

eventSource.addEventListener("brew_event", (event) => {
  if (!isBrewing) return;

  try {
    const data = JSON.parse(event.data);
    const now = Date.now();
    const t = (now - startTime) / 1000; // time in seconds

    if (data.currentTemp !== undefined) {
      currentTempData.push({ x: t, y: data.currentTemp });
      if (currentTempData.length > 1000) currentTempData.shift();
    }

    if (data.targetTemp !== undefined) {
      targetTempData.push({ x: t, y: data.targetTemp });
      if (targetTempData.length > 1000) targetTempData.shift();
    }

    if (data.heaterPower !== undefined) {
      powerData.push({ x: t, y: data.heaterPower });
      if (powerData.length > 1000) powerData.shift();
    }

    chart.update("none");
  } catch (err) {
    console.warn("Bad JSON:", event.data);
  }
});
</script>


</body>
</html>

%FOOTER%
